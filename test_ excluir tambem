-- Drop the existing ENUM type if it exists
DROP TYPE IF EXISTS status_funcionario_enum;
CREATE TYPE status_funcionario_enum AS ENUM ('Indisponível', 'Disponível');

CREATE TABLE IF NOT EXISTS Cliente 
( 
    cp_id_cliente SERIAL,  
    nm_cliente VARCHAR(100) NOT NULL, 
    tel_cliente VARCHAR(15), 
    endereco VARCHAR(255), 
    cpf_cliente VARCHAR(11) NOT NULL,
    qtd_compras INT DEFAULT 0,
    categoria_cliente VARCHAR(10) DEFAULT 'bronze'
); 

CREATE TABLE IF NOT EXISTS Pedido 
( 
    cp_id_pedido SERIAL,  
    ce_cliente INT NOT NULL,  
    data_pedido DATE DEFAULT CURRENT_TIMESTAMP,  
    observações VARCHAR(255),
    status_pedido VARCHAR(20) NOT NULL DEFAULT 'Em aberto', 
    valor_total DECIMAL(10, 2) 
); 

CREATE TABLE IF NOT EXISTS Cargo 
( 
    cp_id_cargo SERIAL,  
    nm_cargo VARCHAR(100) NOT NULL,  
    salario DECIMAL(10, 2),  
    horas_semanais INT
); 

CREATE TABLE IF NOT EXISTS Funcionario 
( 
    cp_id_funcionario SERIAL,  
    ce_cargo INT NOT NULL,  
    nm_funcionario VARCHAR(100) NOT NULL,  
    cpf_funcionario VARCHAR(11),  
    email_funcionario VARCHAR(100),
    tel_funcionario VARCHAR(15),
    tarefas_ativas INT,
    status_funcionario status_funcionario_enum NOT NULL DEFAULT 'Indisponível'
); 

CREATE TABLE IF NOT EXISTS Produto 
( 
    cp_id_produto SERIAL,  
    tipo_produto VARCHAR(100) NOT NULL,  
    nm_produto VARCHAR(100) NOT NULL, 
    preco_produto DECIMAL(10, 2),  
    descricao VARCHAR(255),
    tamanho_pizza VARCHAR(20),  
    volume_bebida VARCHAR(20),    
    qtd_disponivel INT,
    porcentagem_promoção DECIMAL(10, 2) DEFAULT 0
); 

CREATE TABLE IF NOT EXISTS Ingrediente 
( 
    cp_id_ingrediente SERIAL,  
    nm_ingrediente VARCHAR(100) NOT NULL,
    tipo VARCHAR(20) NOT NULL
); 

CREATE TABLE IF NOT EXISTS Funcionario_pedido
( 
    cp_id_pedido_id_funcionario SERIAL,  
    ce_funcionario INT NOT NULL,  
    ce_pedido INT NOT NULL,
    papel VARCHAR(50),  
    observação_funcionário VARCHAR(100)  

); 

CREATE TABLE IF NOT EXISTS Produto_pedido 
( 
    cp_id_pedido_id_produto SERIAL,  
    ce_produto INT NOT NULL,  
    ce_pedido INT NOT NULL, 
    qtd_compradas INT NOT NULL DEFAULT 1
); 

CREATE TABLE IF NOT EXISTS Produto_ingrediente 
( 
    cp_id_produto_id_ingrediente SERIAL,  
    ce_produto INT NOT NULL,  
    ce_ingrediente INT NOT NULL,  
    gramas_ingrediente INT DEFAULT 1
); 
-- Constraints para a tabela Cliente
ALTER TABLE Cliente 
    ADD PRIMARY KEY (cp_id_cliente), 
    ADD UNIQUE (cpf_cliente),
    ADD CHECK (categoria_cliente IN ('bronze', 'prata', 'ouro')),
    ADD CHECK (qtd_compras>=0);

-- Constraints para a tabela Pedido
ALTER TABLE Pedido
    ADD PRIMARY KEY (cp_id_pedido), 
    ADD CHECK (status_pedido IN ('Em aberto', 'Concluído', 'Cancelado')),
    ADD CHECK (valor_total > 0),
    ADD FOREIGN KEY (ce_cliente) REFERENCES Cliente(cp_id_cliente) ON DELETE CASCADE;

-- Constraints para a tabela Cargo
ALTER TABLE Cargo
    ADD PRIMARY KEY (cp_id_cargo),
    ADD CHECK (salario > 0);

-- Constraints para a tabela Funcionario
ALTER TABLE Funcionario
    ADD PRIMARY KEY (cp_id_funcionario),
    ADD UNIQUE (cpf_funcionario),
    ADD CHECK ( tarefas_ativas>=0 ),
    ADD FOREIGN KEY (ce_cargo) REFERENCES Cargo(cp_id_cargo) ON DELETE CASCADE;

-- Constraints para a tabela Produto
ALTER TABLE Produto
    ADD PRIMARY KEY (cp_id_produto),
    ADD CHECK (tipo_produto IN ('pizza', 'aperitivo', 'sobremesa', 'bebida', 'bebida alcoolica', 'utensilios')),
    ADD CHECK (qtd_disponivel > 0),
    ADD CHECK (porcentagem_promoção < 100);

-- Constraints para a tabela Ingrediente
ALTER TABLE Ingrediente
    ADD PRIMARY KEY (cp_id_ingrediente),
    ADD CHECK (tipo IN ('animal', 'vegetal', 'farinha', 'lacticinio', 'outro'));

-- Constraints para a tabela Funcionario_pedido
ALTER TABLE Funcionario_pedido
    ADD PRIMARY KEY (cp_id_pedido_id_funcionario),
    ADD FOREIGN KEY (ce_funcionario) REFERENCES Funcionario(cp_id_funcionario) ON DELETE CASCADE,
    ADD FOREIGN KEY (ce_pedido) REFERENCES Pedido(cp_id_pedido) ON DELETE CASCADE;

-- Constraints para a tabela Produto_pedido
ALTER TABLE Produto_pedido
    ADD PRIMARY KEY (cp_id_pedido_id_produto),
    ADD CHECK (qtd_compradas > 0),
    ADD FOREIGN KEY (ce_produto) REFERENCES Produto(cp_id_produto) ON DELETE CASCADE,
    ADD FOREIGN KEY (ce_pedido) REFERENCES Pedido(cp_id_pedido) ON DELETE CASCADE;

-- Constraints para a tabela Produto_ingrediente
ALTER TABLE Produto_ingrediente
    ADD PRIMARY KEY (cp_id_produto_id_ingrediente),
    ADD CHECK (gramas_ingrediente > 0),
    ADD FOREIGN KEY (ce_produto) REFERENCES Produto(cp_id_produto) ON DELETE CASCADE,
    ADD FOREIGN KEY (ce_ingrediente) REFERENCES Ingrediente(cp_id_ingrediente) ON DELETE CASCADE;

